<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêua Ng·ª±a Chuy√™n Nghi·ªáp v3 - Pro Animation</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; overflow-x: hidden; }
        .setup-panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto 20px auto; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { background: #28a745; color: white; border: none; padding: 15px; border-radius: 6px; cursor: pointer; font-size: 18px; font-weight: bold; width: 100%; transition: 0.3s; }
        button:hover { background: #218838; transform: scale(1.02); }

        #race-track { 
            background: #2e7d32; border: 5px solid #1b5e20; border-radius: 8px; 
            position: relative; display: none; padding: 20px 0;
            max-height: 85vh; overflow-y: auto; scroll-behavior: smooth;
        }
        .lane { 
            height: 100px; border-bottom: 2px dashed rgba(255,255,255,0.2); 
            position: relative; width: 100%; min-width: 2000px; /* ƒê∆∞·ªùng ƒëua d√†i h∆°n */
        }
        
        /* Hi·ªáu ·ª©ng ng·ª±a ch·∫°y nh·∫•p nh√¥ */
        @keyframes gallop {
            0% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-8px) rotate(-2deg); }
            50% { transform: translateY(0) rotate(0deg); }
            75% { transform: translateY(-5px) rotate(2deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }

        .horse-container { 
            position: absolute; left: 0; bottom: 10px; 
            display: flex; flex-direction: column; align-items: center; 
            will-change: left;
        }
        
        .running {
            animation: gallop 0.4s infinite ease-in-out;
        }

        .horse-name { 
            background: rgba(0,0,0,0.8); color: white; padding: 3px 10px; 
            border-radius: 12px; font-size: 12px; font-weight: bold; margin-bottom: 5px;
            white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .horse-img { 
            width: 100px; /* ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc ·∫£nh con ng·ª±a */
            height: auto;
            display: block;
        }
        
        .finish-line { 
            position: absolute; right: 100px; top: 0; bottom: 0; width: 20px; 
            background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px); 
            border-left: 4px solid red; z-index: 10;
        }
        
        #timer-display { text-align: center; font-size: 48px; font-weight: bold; color: #d32f2f; margin: 10px 0; display: none; }
        #result { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: white; padding: 40px; border-radius: 20px; 
            box-shadow: 0 0 100px rgba(0,0,0,0.5); text-align: center; 
            display: none; z-index: 1000;
        }
    </style>
</head>
<body>

<div class="setup-panel" id="setup">
    <h2 style="text-align: center;">üèÅ ƒêUA NG·ª∞A H√åNH ·∫¢NH TH·ª∞C</h2>
    <div class="input-group">
        <label>S·ªë l∆∞·ª£ng (T·ªëi ƒëa 1000):</label>
        <input type="number" id="horseCount" value="5" min="1" max="1000">
    </div>
    <div class="input-group">
        <label>T√™n ng·ª±a (C√°ch nhau b·∫±ng d·∫•u ph·∫©y):</label>
        <textarea id="horseNames" placeholder="X√≠ch Th·ªë, √î Truy, Tuy·∫øt Nh·∫°n..."></textarea>
    </div>
    <div class="input-group" style="display: flex; gap: 10px;">
        <div style="flex: 1;"><label>Ph√∫t:</label><input type="number" id="minutes" value="0"></div>
        <div style="flex: 1;"><label>Gi√¢y:</label><input type="number" id="seconds" value="15"></div>
    </div>
    <button onclick="initRace()">B·∫ÆT ƒê·∫¶U TR·∫¨N ƒê·∫§U</button>
</div>

<div id="timer-display">00:00</div>
<div id="race-track"></div>

<div id="result">
    <h1 id="winner-name"></h1>
    <button onclick="location.reload()">L√ÄM TR·∫¨N M·ªöI</button>
</div>

<audio id="cheerSound" loop>
    <source src="https://www.soundjay.com/human/sounds/crowd-cheer-01.mp3" type="audio/mpeg">
</audio>

<script>
    let animationId;
    const horseImgUrl = "https://manhsacotravel.github.io/dua-ngua/horse.png"; // ƒê·∫£m b·∫£o b·∫°n ƒë√£ t·∫£i ·∫£nh l√™n GitHub v·ªõi t√™n horse.png

    function initRace() {
        const count = parseInt(document.getElementById('horseCount').value);
        const nameInput = document.getElementById('horseNames').value;
        const duration = (parseInt(document.getElementById('minutes').value) * 60) + parseInt(document.getElementById('seconds').value);
        const names = nameInput.split(/[\n,]+/).map(n => n.trim()).filter(n => n !== "");
        
        const track = document.getElementById('race-track');
        track.innerHTML = '<div class="finish-line"></div>';
        track.style.display = 'block';
        document.getElementById('setup').style.display = 'none';
        document.getElementById('timer-display').style.display = 'block';
        document.getElementById('cheerSound').play(); // Ch·∫°y √¢m thanh

        const horses = [];
        for (let i = 0; i < count; i++) {
            const lane = document.createElement('div');
            lane.className = 'lane';
            
            const container = document.createElement('div');
            container.className = 'horse-container running'; // Th√™m class ch·∫°y
            
            // T·∫°o m√†u s·∫Øc ng·∫´u nhi√™n b·∫±ng CSS filter (hue-rotate)
            const randomColor = Math.floor(Math.random() * 360);
            
            container.innerHTML = `
                <span class="horse-name">${names[i] || `Ng·ª±a ${i+1}`}</span>
                <img src="${horseImgUrl}" class="horse-img" style="filter: hue-rotate(${randomColor}deg);">
            `;
            
            lane.appendChild(container);
            track.appendChild(lane);
            
            horses.push({
                el: container,
                name: names[i] || `Ng·ª±a ${i+1}`,
                x: 0,
                velocity: 0,
                boost: Math.random() * 0.05
            });
        }

        startRaceLogic(horses, duration);
    }

    function startRaceLogic(horses, duration) {
        const startTime = performance.now();
        const endTime = startTime + (duration * 1000);
        const finishLineX = window.innerWidth * 2; // ƒê·ªô d√†i ƒë∆∞·ªùng ƒëua

        function frame() {
            const now = performance.now();
            const elapsed = (now - startTime) / 1000;
            const remaining = Math.max(0, (endTime - now) / 1000);

            // C·∫≠p nh·∫≠t ƒë·ªìng h·ªì
            document.getElementById('timer-display').innerText = 
                `${Math.floor(remaining/60).toString().padStart(2,'0')}:${Math.floor(remaining%60).toString().padStart(2,'0')}`;

            let leaderX = 0;
            horses.forEach(h => {
                const progress = elapsed / duration;
                const randomFactor = Math.random() * 0.3;
                
                // Thu·∫≠t to√°n di chuy·ªÉn ch·ªâ ti·∫øn, c√≥ b·ª©t t·ªëc
                h.velocity += (progress * 5 + randomFactor + h.boost) * 0.1;
                h.velocity *= 0.92; // Ma s√°t
                h.x += h.velocity;

                // Gi·ªõi h·∫°n kh√¥ng cho v∆∞·ª£t qu√° v·∫°ch ƒë√≠ch tr∆∞·ªõc th·ªùi gian
                const maxAllowedX = progress * 90; 
                if (h.x > maxAllowedX) h.x = maxAllowedX;

                h.el.style.left = h.x + "%";
                if (h.x > leaderX) leaderX = h.x;
            });

            // Camera b√°m theo con d·∫´n ƒë·∫ßu
            if (leaderX > 30) {
                document.getElementById('race-track').scrollLeft = (leaderX * 20);
            }

            if (now < endTime) {
                animationId = requestAnimationFrame(frame);
            } else {
                const winner = horses.reduce((p, c) => (p.x > c.x) ? p : c);
                showWinner(winner.name);
            }
        }
        animationId = requestAnimationFrame(frame);
    }

    function showWinner(name) {
        document.getElementById('cheerSound').pause();
        document.getElementById('winner-name').innerText = "üèÜ CHI·∫æN TH·∫ÆNG: " + name;
        document.getElementById('result').style.display = 'block';
    }
</script>
</body>
</html>
