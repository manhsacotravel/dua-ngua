<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Äua Ngá»±a Ká»‹ch TÃ­nh v5</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .setup-panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto 20px auto; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { background: #28a745; color: white; border: none; padding: 15px; border-radius: 6px; cursor: pointer; font-size: 18px; font-weight: bold; width: 100%; }

        #race-track { 
            background: #2e7d32; border: 5px solid #1b5e20; border-radius: 8px; 
            position: relative; display: none; padding: 20px 0;
            max-height: 80vh; overflow-y: auto; overflow-x: hidden;
        }
        .lane { 
            height: 95px; border-bottom: 2px dashed rgba(255,255,255,0.2); 
            position: relative; width: 100%;
        }
        
        .horse-container { 
            position: absolute; left: 0; bottom: 5px; 
            display: flex; flex-direction: column; align-items: center; 
            transition: transform 0.1s linear; 
            will-change: transform;
        }

        .horse-name { 
            background: rgba(0,0,0,0.8); color: white; padding: 2px 8px; 
            border-radius: 10px; font-size: 11px; margin-bottom: 2px; white-space: nowrap;
        }
        
        .horse-img { width: 90px; height: auto; display: block; }
        
        .finish-line { 
            position: absolute; right: 100px; top: 0; bottom: 0; width: 15px; 
            background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px); 
            border-left: 3px solid red; z-index: 10;
        }
        
        #timer-display { text-align: center; font-size: 40px; font-weight: bold; color: #d32f2f; margin: 10px 0; display: none; }
        #result { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: white; padding: 40px; border-radius: 20px; 
            box-shadow: 0 0 100px rgba(0,0,0,0.5); text-align: center; 
            display: none; z-index: 1000; border: 5px solid #FFD700;
        }
    </style>
</head>
<body>

<div class="setup-panel" id="setup">
    <div class="version-tag">PhiÃªn báº£n 1.1</div>
    <h2 style="text-align: center;">ğŸ TRÆ¯á»œNG ÄUA NGá»°A NGáºªU NHIÃŠN</h2>
    <div class="input-group">
        <label>Sá»‘ lÆ°á»£ng ngá»±a:</label>
        <input type="number" id="horseCount" value="5">
    </div>
    <div class="input-group">
        <label>TÃªn ngá»±a (cÃ¡ch nhau báº±ng dáº¥u pháº©y):</label>
        <textarea id="horseNames" placeholder="Nháº­p tÃªn ngá»±a táº¡i Ä‘Ã¢y..."></textarea>
    </div>
    <div class="input-group" style="display: flex; gap: 10px;">
        <div style="flex: 1;"><label>PhÃºt:</label><input type="number" id="minutes" value="0"></div>
        <div style="flex: 1;"><label>GiÃ¢y:</label><input type="number" id="seconds" value="20"></div>
    </div>
    <button id="startBtn" onclick="initRace()">Báº®T Äáº¦U ÄUA</button>
</div>

<div id="timer-display">00:00</div>
<div id="race-track"></div>

<div id="result">
    <h1 id="winner-name"></h1>
    <p style="font-size: 20px;">ğŸ† ÄÃƒ Vá»€ ÄÃCH Äáº¦U TIÃŠN!</p>
    <button onclick="location.reload()" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">ÄUA Láº I</button>
</div>

<audio id="cheerSound" loop>
    <source src="audio.mp3" type="audio/mpeg">
</audio>

<script>
    let animationId;
    const horseImgUrl = "horse.png"; 

    function initRace() {
        const audio = document.getElementById('cheerSound');
        audio.currentTime = 0;
        audio.play().catch(e => console.log("YÃªu cáº§u tÆ°Æ¡ng tÃ¡c Ä‘á»ƒ phÃ¡t nháº¡c"));

        const count = parseInt(document.getElementById('horseCount').value);
        const nameInput = document.getElementById('horseNames').value;
        const totalSec = (parseInt(document.getElementById('minutes').value) * 60) + parseInt(document.getElementById('seconds').value);
        const names = nameInput.split(/[\n,]+/).map(n => n.trim()).filter(n => n !== "");
        
        const track = document.getElementById('race-track');
        track.innerHTML = '<div class="finish-line"></div>';
        track.style.display = 'block';
        document.getElementById('setup').style.display = 'none';
        document.getElementById('timer-display').style.display = 'block';

        const horses = [];
        for (let i = 0; i < count; i++) {
            const lane = document.createElement('div');
            lane.className = 'lane';
            const container = document.createElement('div');
            container.className = 'horse-container';
            
            const hue = Math.floor(Math.random() * 360);
            container.innerHTML = `
                <span class="horse-name">${names[i] || `Ngá»±a ${i+1}`}</span>
                <img src="${horseImgUrl}" class="horse-img" style="filter: hue-rotate(${hue}deg);">
            `;
            
            lane.appendChild(container);
            track.appendChild(lane);
            
            // Thuáº­t toÃ¡n: Má»—i con cÃ³ tá»‘c Ä‘á»™ cÆ¡ báº£n (Base Speed) chÃªnh lá»‡ch tá»‘i Ä‘a 30%
            const baseFactor = 0.85 + (Math.random() * 0.30); // Tá»« 0.85 Ä‘áº¿n 1.15

            horses.push({
                el: container,
                name: names[i] || `Ngá»±a ${i+1}`,
                x: 0,
                finished: false,
                baseFactor: baseFactor,
                currentVelocity: 0
            });
        }

        runRace(horses, totalSec);
    }

    function runRace(horses, duration) {
        const start = performance.now();
        const end = start + (duration * 1000);
        const finishX = 85; 

        function frame() {
            const now = performance.now();
            const elapsed = (now - start) / 1000;
            const remaining = Math.max(0, (end - now) / 1000);

            document.getElementById('timer-display').innerText = 
                `${Math.floor(remaining/60).toString().padStart(2,'0')}:${Math.floor(remaining%60).toString().padStart(2,'0')}`;

            let winnerFound = null;

            horses.forEach(h => {
                if (!h.finished) {
                    const timeProgress = elapsed / duration;
                    
                    // Thuáº­t toÃ¡n ngáº«u nhiÃªn: 
                    // 1. Tiáº¿n Ä‘á»™ chung dá»±a trÃªn thá»i gian
                    // 2. NhÃ¢n vá»›i há»‡ sá»‘ tá»‘c Ä‘á»™ riÃªng (baseFactor)
                    // 3. ThÃªm má»™t chÃºt biáº¿n Ä‘á»™ng ngáº«u nhiÃªn theo tá»«ng khung hÃ¬nh (Luck factor)
                    const luck = 0.98 + (Math.random() * 0.04); // Biáº¿n Ä‘á»™ng nhá» Ä‘á»ƒ mÆ°á»£t
                    
                    // Vá»‹ trÃ­ má»¥c tiÃªu lÃ½ tÆ°á»Ÿng
                    let targetX = timeProgress * finishX * h.baseFactor * luck;

                    // Äáº£m báº£o ngá»±a khÃ´ng Ä‘á»©ng yÃªn hoáº·c cháº¡y lÃ¹i
                    if (targetX < h.x) targetX = h.x + 0.01;

                    if (targetX >= finishX) {
                        targetX = finishX;
                        h.finished = true;
                        if (!winnerFound) winnerFound = h;
                    }
                    
                    h.x = targetX;
                    h.el.style.transform = `translateX(${h.x}vw)`;
                }
            });

            if (now < end && !winnerFound) {
                animationId = requestAnimationFrame(frame);
            } else {
                // Dá»«ng Ã¢m thanh khi cÃ³ ngÆ°á»i tháº¯ng
                document.getElementById('cheerSound').pause();
                
                // TÃ¬m ngÆ°á»i cÃ³ vá»‹ trÃ­ xa nháº¥t thá»±c táº¿ (náº¿u háº¿t thá»i gian mÃ  chÆ°a ai cháº¡m Ä‘Ã­ch)
                const winner = winnerFound || horses.reduce((p, c) => (p.x > c.x) ? p : c);
                document.getElementById('winner-name').innerText = winner.name;
                document.getElementById('result').style.display = 'block';
            }
        }
        animationId = requestAnimationFrame(frame);
    }
</script>
</body>
</html>


