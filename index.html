<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêua Ng·ª±a K·ªãch T√≠nh v5</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .setup-panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto 20px auto; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { background: #28a745; color: white; border: none; padding: 15px; border-radius: 6px; cursor: pointer; font-size: 18px; font-weight: bold; width: 100%; }

        #race-track { 
            background: #2e7d32; border: 5px solid #1b5e20; border-radius: 8px; 
            position: relative; display: none; padding: 20px 0;
            max-height: 80vh; overflow-y: auto; overflow-x: hidden;
        }
        .lane { 
            height: 95px; border-bottom: 2px dashed rgba(255,255,255,0.2); 
            position: relative; width: 100%;
        }
        
        .horse-container { 
            position: absolute; left: 0; bottom: 5px; 
            display: flex; flex-direction: column; align-items: center; 
            transition: transform 0.1s linear; 
            will-change: transform;
        }

        .horse-name { 
            background: rgba(0,0,0,0.8); color: white; padding: 2px 8px; 
            border-radius: 10px; font-size: 11px; margin-bottom: 2px; white-space: nowrap;
        }
        
        .horse-img { width: 90px; height: auto; display: block; }
        
        .finish-line { 
            position: absolute; right: 100px; top: 0; bottom: 0; width: 15px; 
            background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px); 
            border-left: 3px solid red; z-index: 10;
        }
        
        #timer-display { text-align: center; font-size: 40px; font-weight: bold; color: #d32f2f; margin: 10px 0; display: none; }
        #result { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: white; padding: 40px; border-radius: 20px; 
            box-shadow: 0 0 100px rgba(0,0,0,0.5); text-align: center; 
            display: none; z-index: 1000; border: 5px solid #FFD700;
        }
    </style>
</head>
<body>

<div class="setup-panel" id="setup">
    <h2 style="text-align: center;">üèÅ TR∆Ø·ªúNG ƒêUA NG·ª∞A NG·∫™U NHI√äN</h2>
    <div class="input-group">
        <label>S·ªë l∆∞·ª£ng ng·ª±a:</label>
        <input type="number" id="horseCount" value="5">
    </div>
    <div class="input-group">
        <label>T√™n ng·ª±a (c√°ch nhau b·∫±ng d·∫•u ph·∫©y):</label>
        <textarea id="horseNames" placeholder="Nh·∫≠p t√™n ng·ª±a t·∫°i ƒë√¢y..."></textarea>
    </div>
    <div class="input-group" style="display: flex; gap: 10px;">
        <div style="flex: 1;"><label>Ph√∫t:</label><input type="number" id="minutes" value="0"></div>
        <div style="flex: 1;"><label>Gi√¢y:</label><input type="number" id="seconds" value="20"></div>
    </div>
    <button id="startBtn" onclick="initRace()">B·∫ÆT ƒê·∫¶U ƒêUA</button>
</div>

<div id="timer-display">00:00</div>
<div id="race-track"></div>

<div id="result">
    <h1 id="winner-name"></h1>
    <p style="font-size: 20px;">üèÜ ƒê√É V·ªÄ ƒê√çCH ƒê·∫¶U TI√äN!</p>
    <button onclick="location.reload()" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">ƒêUA L·∫†I</button>
</div>

<audio id="cheerSound" loop>
    <source src="https://assets.mixkit.co/active_storage/sfx/2016/2016-preview.mp3" type="audio/mpeg">
</audio>

<script>
    let animationId;
    const horseImgUrl = "horse.png"; 

    function initRace() {
        const audio = document.getElementById('cheerSound');
        audio.currentTime = 0;
        audio.play().catch(e => console.log("Y√™u c·∫ßu t∆∞∆°ng t√°c ƒë·ªÉ ph√°t nh·∫°c"));

        const count = parseInt(document.getElementById('horseCount').value);
        const nameInput = document.getElementById('horseNames').value;
        const totalSec = (parseInt(document.getElementById('minutes').value) * 60) + parseInt(document.getElementById('seconds').value);
        const names = nameInput.split(/[\n,]+/).map(n => n.trim()).filter(n => n !== "");
        
        const track = document.getElementById('race-track');
        track.innerHTML = '<div class="finish-line"></div>';
        track.style.display = 'block';
        document.getElementById('setup').style.display = 'none';
        document.getElementById('timer-display').style.display = 'block';

        const horses = [];
        for (let i = 0; i < count; i++) {
            const lane = document.createElement('div');
            lane.className = 'lane';
            const container = document.createElement('div');
            container.className = 'horse-container';
            
            const hue = Math.floor(Math.random() * 360);
            container.innerHTML = `
                <span class="horse-name">${names[i] || `Ng·ª±a ${i+1}`}</span>
                <img src="${horseImgUrl}" class="horse-img" style="filter: hue-rotate(${hue}deg);">
            `;
            
            lane.appendChild(container);
            track.appendChild(lane);
            
            // Thu·∫≠t to√°n: M·ªói con c√≥ t·ªëc ƒë·ªô c∆° b·∫£n (Base Speed) ch√™nh l·ªách t·ªëi ƒëa 30%
            const baseFactor = 0.85 + (Math.random() * 0.30); // T·ª´ 0.85 ƒë·∫øn 1.15

            horses.push({
                el: container,
                name: names[i] || `Ng·ª±a ${i+1}`,
                x: 0,
                finished: false,
                baseFactor: baseFactor,
                currentVelocity: 0
            });
        }

        runRace(horses, totalSec);
    }

    function runRace(horses, duration) {
        const start = performance.now();
        const end = start + (duration * 1000);
        const finishX = 85; 

        function frame() {
            const now = performance.now();
            const elapsed = (now - start) / 1000;
            const remaining = Math.max(0, (end - now) / 1000);

            document.getElementById('timer-display').innerText = 
                `${Math.floor(remaining/60).toString().padStart(2,'0')}:${Math.floor(remaining%60).toString().padStart(2,'0')}`;

            let winnerFound = null;

            horses.forEach(h => {
                if (!h.finished) {
                    const timeProgress = elapsed / duration;
                    
                    // Thu·∫≠t to√°n ng·∫´u nhi√™n: 
                    // 1. Ti·∫øn ƒë·ªô chung d·ª±a tr√™n th·ªùi gian
                    // 2. Nh√¢n v·ªõi h·ªá s·ªë t·ªëc ƒë·ªô ri√™ng (baseFactor)
                    // 3. Th√™m m·ªôt ch√∫t bi·∫øn ƒë·ªông ng·∫´u nhi√™n theo t·ª´ng khung h√¨nh (Luck factor)
                    const luck = 0.98 + (Math.random() * 0.04); // Bi·∫øn ƒë·ªông nh·ªè ƒë·ªÉ m∆∞·ª£t
                    
                    // V·ªã tr√≠ m·ª•c ti√™u l√Ω t∆∞·ªüng
                    let targetX = timeProgress * finishX * h.baseFactor * luck;

                    // ƒê·∫£m b·∫£o ng·ª±a kh√¥ng ƒë·ª©ng y√™n ho·∫∑c ch·∫°y l√πi
                    if (targetX < h.x) targetX = h.x + 0.01;

                    if (targetX >= finishX) {
                        targetX = finishX;
                        h.finished = true;
                        if (!winnerFound) winnerFound = h;
                    }
                    
                    h.x = targetX;
                    h.el.style.transform = `translateX(${h.x}vw)`;
                }
            });

            if (now < end && !winnerFound) {
                animationId = requestAnimationFrame(frame);
            } else {
                // D·ª´ng √¢m thanh khi c√≥ ng∆∞·ªùi th·∫Øng
                document.getElementById('cheerSound').pause();
                
                // T√¨m ng∆∞·ªùi c√≥ v·ªã tr√≠ xa nh·∫•t th·ª±c t·∫ø (n·∫øu h·∫øt th·ªùi gian m√† ch∆∞a ai ch·∫°m ƒë√≠ch)
                const winner = winnerFound || horses.reduce((p, c) => (p.x > c.x) ? p : c);
                document.getElementById('winner-name').innerText = winner.name;
                document.getElementById('result').style.display = 'block';
            }
        }
        animationId = requestAnimationFrame(frame);
    }
</script>
</body>
</html>
